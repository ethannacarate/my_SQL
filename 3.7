-- MySQL Workbench Forward Engineering

SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- -----------------------------------------------------
-- Schema mydb
-- -----------------------------------------------------
-- -----------------------------------------------------
-- Schema seguridad_plazas
-- -----------------------------------------------------

-- -----------------------------------------------------
-- Schema seguridad_plazas
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS `seguridad_plazas` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ;
USE `seguridad_plazas` ;

-- -----------------------------------------------------
-- Table `seguridad_plazas`.`plazas`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `seguridad_plazas`.`plazas` (
  `id_plaza` INT NOT NULL AUTO_INCREMENT,
  `nombre_plaza` VARCHAR(100) NOT NULL,
  `direccion` VARCHAR(255) NOT NULL,
  `deleted` TINYINT(1) NOT NULL DEFAULT '0' COMMENT 'Borrado lógico: 0=activo, 1=eliminado',
  `comuna` VARCHAR(100) NULL DEFAULT NULL,
  `junta_vecinos` VARCHAR(255) NULL DEFAULT NULL,
  `created_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_plaza`),
  UNIQUE INDEX `nombre_plaza` (`nombre_plaza` ASC, `direccion` ASC) VISIBLE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `seguridad_plazas`.`camaras`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `seguridad_plazas`.`camaras` (
  `id_camara` INT NOT NULL AUTO_INCREMENT,
  `id_plaza` INT NOT NULL COMMENT 'FK a la tabla plazas',
  `nombre_camara` VARCHAR(100) NOT NULL,
  `deleted` TINYINT(1) NOT NULL DEFAULT '0',
  `ubicacion` VARCHAR(255) NULL DEFAULT NULL,
  `estado` ENUM('activo', 'inactivo', 'mantenimiento') NULL DEFAULT 'activo',
  `automatizada` TINYINT(1) NULL DEFAULT '1' COMMENT '1=Genera alertas IA, 0=Solo visualización',
  `created_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_camara`),
  UNIQUE INDEX `id_plaza` (`id_plaza` ASC, `nombre_camara` ASC) VISIBLE,
  INDEX `idx_camaras_plaza` (`id_plaza` ASC) VISIBLE,
  CONSTRAINT `fk_camaras_plazas`
    FOREIGN KEY (`id_plaza`)
    REFERENCES `seguridad_plazas`.`plazas` (`id_plaza`)
    ON DELETE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `seguridad_plazas`.`reportes`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `seguridad_plazas`.`reportes` (
  `id_reporte` INT NOT NULL AUTO_INCREMENT,
  `id_plaza` INT NOT NULL COMMENT 'FK a la tabla plazas',
  `id_camara` INT NOT NULL COMMENT 'FK a la cámara que lo captó (opcional)',
  `tipo_reporte` VARCHAR(100) NOT NULL COMMENT 'Ej: Vandalismo, Robo, Actividad Sospechosa',
  `fecha_reporte` DATE NOT NULL,
  `hora_reporte` TIME NOT NULL,
  `deleted` TINYINT(1) NOT NULL DEFAULT '0',
  `estado` ENUM('abierto', 'en_progreso', 'resuelto') NULL DEFAULT 'abierto',
  `gravedad` TINYINT NULL DEFAULT '3' COMMENT 'Nivel de gravedad (1-5)',
  `descripcion` TEXT NULL DEFAULT NULL,
  `archivo_adjunto` VARCHAR(255) NULL DEFAULT NULL,
  `created_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_reporte`),
  INDEX `fk_reportes_camaras` (`id_camara` ASC) VISIBLE,
  INDEX `idx_reportes_plaza` (`id_plaza` ASC) VISIBLE,
  INDEX `idx_reportes_estado` (`estado` ASC) VISIBLE,
  CONSTRAINT `fk_reportes_camaras`
    FOREIGN KEY (`id_camara`)
    REFERENCES `seguridad_plazas`.`camaras` (`id_camara`)
    ON DELETE SET NULL,
  CONSTRAINT `fk_reportes_plazas`
    FOREIGN KEY (`id_plaza`)
    REFERENCES `seguridad_plazas`.`plazas` (`id_plaza`)
    ON DELETE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `seguridad_plazas`.`roles`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `seguridad_plazas`.`roles` (
  `id_rol` INT NOT NULL AUTO_INCREMENT,
  `nombre_rol` VARCHAR(50) NOT NULL COMMENT 'Ej: Administrador, Operador, Vecino',
  `deleted` TINYINT(1) NOT NULL DEFAULT '0',
  `descripcion` TEXT NULL DEFAULT NULL,
  `created_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_rol`),
  UNIQUE INDEX `nombre_rol` (`nombre_rol` ASC) VISIBLE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `seguridad_plazas`.`usuarios`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `seguridad_plazas`.`usuarios` (
  `id_usuario` INT NOT NULL AUTO_INCREMENT,
  `id_rol` INT NOT NULL COMMENT 'FK a la tabla roles',
  `id_plaza` INT NOT NULL COMMENT 'FK a la plaza asociada (si aplica)',
  `rut` VARCHAR(20) NOT NULL,
  `deleted` TINYINT(1) NOT NULL DEFAULT '0',
  `correo` VARCHAR(100) NOT NULL,
  `password_hash` VARCHAR(255) NOT NULL,
  `nombre_usuario` VARCHAR(100) NULL DEFAULT NULL,
  `telefono` VARCHAR(30) NULL DEFAULT NULL,
  `activo` TINYINT(1) NULL DEFAULT '1' COMMENT '1=activo, 0=inactivo',
  `fecha_registro` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `created_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `modified_by` INT NULL DEFAULT NULL,
  PRIMARY KEY (`id_usuario`),
  UNIQUE INDEX `rut` (`rut` ASC) VISIBLE,
  UNIQUE INDEX `correo` (`correo` ASC) VISIBLE,
  INDEX `idx_usuarios_rol` (`id_rol` ASC) VISIBLE,
  INDEX `idx_usuarios_plaza` (`id_plaza` ASC) VISIBLE,
  CONSTRAINT `fk_usuarios_plazas`
    FOREIGN KEY (`id_plaza`)
    REFERENCES `seguridad_plazas`.`plazas` (`id_plaza`)
    ON DELETE SET NULL
    ON UPDATE CASCADE,
  CONSTRAINT `fk_usuarios_roles`
    FOREIGN KEY (`id_rol`)
    REFERENCES `seguridad_plazas`.`roles` (`id_rol`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `seguridad_plazas`.`alertas`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `seguridad_plazas`.`alertas` (
  `id_alerta` INT NOT NULL AUTO_INCREMENT,
  `id_camara` INT NOT NULL COMMENT 'FK a la cámara que genera la alerta',
  `id_reporte_asociado` INT NOT NULL COMMENT 'FK al reporte (si la alerta se escala)',
  `id_usuario_revisor` INT NOT NULL COMMENT 'FK al operador que la gestionó',
  `tipo_alerta` VARCHAR(50) NOT NULL COMMENT 'Ej: MOVIMIENTO_SOSPECHOSO, SONIDO_FUERTE',
  `timestamp_alerta` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `estado_alerta` ENUM('pendiente', 'revisada', 'descartada', 'escalada') NOT NULL DEFAULT 'pendiente',
  `deleted` TINYINT(1) NOT NULL DEFAULT '0',
  `created_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_alerta`),
  INDEX `idx_alertas_camara` (`id_camara` ASC) VISIBLE,
  INDEX `idx_alertas_usuario` (`id_usuario_revisor` ASC) VISIBLE,
  INDEX `idx_alertas_reporte` (`id_reporte_asociado` ASC) VISIBLE,
  CONSTRAINT `fk_alertas_camaras`
    FOREIGN KEY (`id_camara`)
    REFERENCES `seguridad_plazas`.`camaras` (`id_camara`)
    ON DELETE CASCADE,
  CONSTRAINT `fk_alertas_reportes`
    FOREIGN KEY (`id_reporte_asociado`)
    REFERENCES `seguridad_plazas`.`reportes` (`id_reporte`)
    ON DELETE SET NULL,
  CONSTRAINT `fk_alertas_usuarios`
    FOREIGN KEY (`id_usuario_revisor`)
    REFERENCES `seguridad_plazas`.`usuarios` (`id_usuario`)
    ON DELETE SET NULL)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


-- -----------------------------------------------------
-- Table `seguridad_plazas`.`reporte_usuarios`
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS `seguridad_plazas`.`reporte_usuarios` (
  `id_reporte` INT NOT NULL COMMENT 'FK a la tabla reportes',
  `id_usuario` INT NOT NULL COMMENT 'FK a la tabla usuarios',
  `rol_en_reporte` VARCHAR(50) NOT NULL COMMENT 'Ej: reportado_por, asignado_a',
  `fecha_asociado` DATETIME NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id_reporte`, `id_usuario`),
  INDEX `fk_ru_usuarios` (`id_usuario` ASC) VISIBLE,
  CONSTRAINT `fk_ru_reportes`
    FOREIGN KEY (`id_reporte`)
    REFERENCES `seguridad_plazas`.`reportes` (`id_reporte`)
    ON DELETE CASCADE,
  CONSTRAINT `fk_ru_usuarios`
    FOREIGN KEY (`id_usuario`)
    REFERENCES `seguridad_plazas`.`usuarios` (`id_usuario`)
    ON DELETE CASCADE)
ENGINE = InnoDB
DEFAULT CHARACTER SET = utf8mb4
COLLATE = utf8mb4_unicode_ci;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;
